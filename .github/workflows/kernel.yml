name: Build kernels

on:
  push:
    paths:
      - ".github/workflows/kernel.yml"
  workflow_dispatch:
  schedule:
    - cron: "14 13 * * 5"

jobs:
  Read-configuration:
    name: üêÇ Parse *.config.json
    runs-on: ubuntu-latest
    outputs:
      CONFIGS: ${{ steps.generate-matrix.outputs.CONFIGS }}
      BUILD_DATE: ${{ steps.generate-builddate.outputs.BUILDDATE }}
    steps:
      - name: üòÑ Checkout
        uses: actions/checkout@v4

      - name: üòÜ Generate Matrix
        id: generate-matrix
        run: |
          echo "CONFIGS<<EOF" >> $GITHUB_OUTPUT
          jq -s '[.[][]]' Kernel/configs/*.config.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ‚è∞ Set builddate
        id: generate-builddate
        run: echo "BUILDDATE=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

  Build-Kernel:
    name: "üêé Build kernel"
    runs-on: ubuntu-latest
    needs:
      - Read-configuration
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        CONFIG: ${{ fromJSON(needs.Read-configuration.outputs.CONFIGS) }}
    env:
      WORKSPACE: ${{ github.workspace }}
      BUILD_DATE: ${{ needs.Read-configuration.outputs.BUILD_DATE }}
      OUT_DIR: "${{ github.workspace }}/out"
      CCACHE_DIR: "${{ github.workspace }}/ccache"
    steps:
      - name: üòÑ Checkout kernel
        uses: actions/checkout@v4

      - name: ‚≠ê Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl git wget unzip zip tar rar python3 python3-dev build-essential bc \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi clang lld make \
            ccache libssl-dev libncurses-dev device-tree-compiler pngcrush schedtool \
            dpkg-dev liblz4-tool optipng maven lib32z1 libgl1-mesa-dev \
            bison gperf zlib1g-dev automake flex tree libxml2-utils squashfs-tools lzop \
            pwgen libc6-dev-i386

      - name: üßπ Clean old kernel
        run: |
          KERNEL_DIR="${{ env.WORKSPACE }}/${{ matrix.CONFIG.kernelSource.name }}"
          echo "Deleting $KERNEL_DIR if exists"
          [ -d "$KERNEL_DIR" ] && rm -rf "$KERNEL_DIR"

      - name: üåü Clone kernel source
        run: |
          git clone --recursive --depth=1 -j $(nproc) \
          --branch ${{ matrix.CONFIG.kernelSource.branch }} \
          ${{ matrix.CONFIG.kernelSource.repo }} \
          ${{ matrix.CONFIG.kernelSource.name }}

      - name: üßπ Init kernel config
        run: |
          cd "${{ env.WORKSPACE }}/${{ matrix.CONFIG.kernelSource.name }}"
          make ARCH=arm64 mrproper
          make ARCH=arm64 O="${{ env.OUT_DIR }}" ${{ matrix.CONFIG.kernelSource.defconfig }}
          sed -i 's/CONFIG_NR_CPUS=.*/CONFIG_NR_CPUS=8/' "${{ env.OUT_DIR }}/.config" || echo "CONFIG_NR_CPUS=8" >> "${{ env.OUT_DIR }}/.config"
          sed -i 's/# CONFIG_SMP is not set/CONFIG_SMP=y/' "${{ env.OUT_DIR }}/.config" || true
          make ARCH=arm64 O="${{ env.OUT_DIR }}" olddefconfig

      - name: üòé Set build args
        id: generate-args
        run: |
          THREAD=$(nproc --all)
          ARCH=$(echo '${{ toJSON(matrix.CONFIG.params) }}' | jq -r ".ARCH")

          # Êù°‰ª∂ÊâßË°å LXC / KSU / Nethunter
          case "${{ matrix.CONFIG.kernelSource.name }}" in
            *LXC*) BUILD_LXC=true ;;
            *) BUILD_LXC=false ;;
          esac

          case "${{ matrix.CONFIG.kernelSource.name }}" in
            *KSU*) BUILD_KSU=true ;;
            *) BUILD_KSU=false ;;
          esac

          case "${{ matrix.CONFIG.kernelSource.name }}" in
            *Nethunter*) BUILD_NETHUNTER=true ;;
            *) BUILD_NETHUNTER=false ;;
          esac

          # GCC for KSU / Nethunter, Clang for others
          if [ "$BUILD_KSU" = true ] || [ "$BUILD_NETHUNTER" = true ]; then
              CC=gcc-aarch64-linux-gnu
              LLVM=0
          else
              CC=$(echo '${{ toJSON(matrix.CONFIG.params) }}' | jq -r ".CC")
              LLVM=1
          fi

          ARGS="-j$THREAD O=${{ env.OUT_DIR }} ARCH=$ARCH LLVM=$LLVM"
          if [ -n "$CC" ]; then
            if [[ "$CC" == */* ]]; then CC="${{ env.WORKSPACE }}/$CC"; fi
            if [ '${{ matrix.CONFIG.enableCcache }}' = "true" ]; then
              ARGS="$ARGS CC=\"ccache $CC\""
            else
              ARGS="$ARGS CC=$CC"
            fi
          fi

          echo "ARCH=$ARCH" >> $GITHUB_OUTPUT
          echo "ARGS=$ARGS" >> $GITHUB_OUTPUT
          echo "BUILD_LXC=$BUILD_LXC" >> $GITHUB_OUTPUT
          echo "BUILD_KSU=$BUILD_KSU" >> $GITHUB_OUTPUT
          echo "BUILD_NETHUNTER=$BUILD_NETHUNTER" >> $GITHUB_OUTPUT
          echo "ü§î $ARGS"

      - name: üëç Build kernel
        if: ${{ matrix.CONFIG.buildKernel != 'false' }}
        working-directory: ${{ env.WORKSPACE }}/${{ matrix.CONFIG.kernelSource.name }}
        run: |
          export KBUILD_BUILD_HOST=dammer
          export KBUILD_BUILD_USER=dammer
          make ${{ steps.generate-args.outputs.ARGS }} ${{ matrix.CONFIG.kernelSource.defconfig }}
          make ${{ steps.generate-args.outputs.ARGS }}

      - name: üíõ Upload Images & dtb
        if: ${{ matrix.CONFIG.buildKernel != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}-Image
          path: ${{ env.OUT_DIR }}/arch/${{ steps.generate-args.outputs.ARCH }}/boot/
          retention-days: 7

      - name: ‚è∞ Pack AnyKernel3
        if: ${{ matrix.CONFIG.AnyKernel3.use == 'true' }}
        run: |
          git clone --recursive --depth=1 -j $(nproc) https://github.com/osm0sis/AnyKernel3 AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          cp -f ${{ env.OUT_DIR }}/arch/${{ steps.generate-args.outputs.ARCH }}/boot/* AnyKernel3/
          cd AnyKernel3
          zip -q -r "${{ env.WORKSPACE }}/AnyKernel3-${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}.zip" *

      - name: üíæ Upload AnyKernel3
        if: ${{ matrix.CONFIG.AnyKernel3.use == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}
          path: ${{ env.WORKSPACE }}/AnyKernel3-${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}.zip

