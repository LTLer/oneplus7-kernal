name: Build kernels

on:
  push:
    paths:
      - ".github/workflows/kernel.yml"
  workflow_dispatch:
  schedule:
    - cron: "14 13 * * 5"

jobs:
  Read-configuration:
    name: üêÇ Parse *.config.json
    runs-on: ubuntu-latest
    outputs:
      CONFIGS: ${{ steps.generate-matrix.outputs.CONFIGS }}
      BUILD_DATE: ${{ steps.generate-builddate.outputs.BUILDDATE }}
    steps:
      - name: üòÑ Checkout
        uses: actions/checkout@v4

      - name: üòÜ Generate Matrix
        id: generate-matrix
        run: |
          echo "CONFIGS<<EOF" >> $GITHUB_OUTPUT
          jq -s '[.[][]]' Kernel/configs/*.config.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ‚è∞ Set builddate
        id: generate-builddate
        run: echo "BUILDDATE=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

  Build-Kernel:
    name: "üêé Build kernel"
    runs-on: ubuntu-latest
    needs: Read-configuration
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        CONFIG: ${{ fromJSON(needs.Read-configuration.outputs.CONFIGS) }}
    env:
      WORKSPACE: ${{ github.workspace }}
      BUILD_DATE: ${{ needs.Read-configuration.outputs.BUILD_DATE }}
      OUT_DIR: "${{ github.workspace }}/out"
      CCACHE_DIR: "${{ github.workspace }}/ccache"
    steps:
      - name: üòÑ Checkout kernel
        uses: actions/checkout@v4

      - name: ‚≠ê Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl git wget unzip zip tar rar unrar python3 python3-dev build-essential bc \
            clang llvm lld make gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            ccache libssl-dev libncurses-dev device-tree-compiler pngcrush schedtool \
            dpkg-dev liblz4-tool optipng maven lib32z1 libgl1-mesa-dev \
            bison gperf zlib1g-dev automake flex tree libxml2-utils squashfs-tools lzop \
            pwgen libc6-dev-i386

      - name: üìê Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: üí´ Get toolchains
        env:
          toolchains: "${{ toJSON(matrix.CONFIG.toolchains) }}"
        run: |
          git lfs install
          toolchains_num=$(echo "$toolchains" | jq 'length')
          echo "ü§î There is $toolchains_num defined toolchains."

          for ((i=0;i<toolchains_num;i++)); do
            toolchain=$(echo "$toolchains" | jq -r ".[$i]")
            toolchain_name=$(echo "$toolchain" | jq -r ".name")

            if echo "$toolchain" | jq -e 'has("url")' > /dev/null; then
              url=$(echo "$toolchain" | jq -r ".url")
              mkdir -p "$toolchain_name"
              file="${url##*/}"
              wget -q -O "$file" "$url"
              case "$file" in
                *.zip) unzip -q -d "$toolchain_name" "$file" ;;
                *.tar.gz|*.tgz) tar xzf "$file" -C "$toolchain_name" ;;
                *.tar) tar xf "$file" -C "$toolchain_name" ;;
                *.rar) unrar x "$file" "$toolchain_name" ;;
                *) echo "unknown file type: $file" ;;
              esac
              rm "$file"
            else
              repo=$(echo "$toolchain" | jq -r ".repo")
              branch=$(echo "$toolchain" | jq -r ".branch")
              git clone --recursive --depth=1 --branch "$branch" "$repo" "$toolchain_name"
            fi

            clang_path="$WORKSPACE/$toolchain_name/bin/clang"
            lld_path="$WORKSPACE/$toolchain_name/bin/ld.lld"
            if [ ! -x "$clang_path" ] || [ ! -x "$lld_path" ]; then
              echo "‚ùå ERROR: clang or ld.lld missing in $toolchain_name/bin"
              exit 1
            fi
            echo "$WORKSPACE/$toolchain_name/bin" >> $GITHUB_PATH
          done

      - name: üöÑ Setup ccache
        if: ${{ matrix.CONFIG.enableCcache == 'true' }}
        run: |
          mkdir -p ${{ env.OUT_DIR }} ${{ env.CCACHE_DIR }}
          ccache -o compression=false -o cache_dir=${{ env.CCACHE_DIR }}
          HASH=$(echo -n '${{ toJSON(matrix.CONFIG) }}' | openssl dgst -sha1 | awk '{print $2}')
          echo "HASH=$HASH" >> $GITHUB_OUTPUT

      - name: üöÖ Cache ccache & output
        if: ${{ matrix.CONFIG.enableCcache == 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.OUT_DIR }}
            ${{ env.CCACHE_DIR }}
          key: cache-${{ matrix.CONFIG.kernelSource.name }}-${{ steps.hash.outputs.HASH }}-${{ env.BUILD_DATE }}
          restore-keys: |
            cache-${{ matrix.CONFIG.kernelSource.name }}-${{ steps.hash.outputs.HASH }}-
            cache-${{ matrix.CONFIG.kernelSource.name }}-

      - name: üßπ Clean old kernel
        run: |
          KERNEL_DIR="${{ github.workspace }}/${{ matrix.CONFIG.kernelSource.name }}"
          if [ -d "$KERNEL_DIR" ]; then
            echo "Removing existing kernel directory: $KERNEL_DIR"
            rm -rf "$KERNEL_DIR"
          fi

      - name: üåü Clone kernel source
        run: |
          git clone --recursive --depth=1 -j $(nproc) \
          --branch ${{ matrix.CONFIG.kernelSource.branch }} \
          ${{ matrix.CONFIG.kernelSource.repo }} \
          ${{ matrix.CONFIG.kernelSource.name }}

      - name: üßπ Clean & init kernel config
        run: |
          cd ${{ github.workspace }}/${{ matrix.CONFIG.kernelSource.name }}
          make ARCH=arm64 mrproper
          make ARCH=arm64 O=${{ env.OUT_DIR }} ${{ matrix.CONFIG.kernelSource.defconfig }}
          sed -i 's/CONFIG_NR_CPUS=.*/CONFIG_NR_CPUS=8/' ${{ env.OUT_DIR }}/.config || echo "CONFIG_NR_CPUS=8" >> ${{ env.OUT_DIR }}/.config
          sed -i 's/# CONFIG_SMP is not set/CONFIG_SMP=y/' ${{ env.OUT_DIR }}/.config || true
          make ARCH=arm64 O=${{ env.OUT_DIR }} olddefconfig

      - name: üòé Set build args
        id: generate-args
        run: |
          THREAD=$(nproc --all)
          ARCH=$(echo '${{ toJSON(matrix.CONFIG.params) }}' | jq -r ".ARCH")
          CC=$(echo '${{ toJSON(matrix.CONFIG.params) }}' | jq -r ".CC")
          ARGS="-j$THREAD O=${{ env.OUT_DIR }} ARCH=$ARCH LLVM=1"
          if [ -n "$CC" ]; then
            if [[ "$CC" == */* ]]; then CC="${{ github.workspace }}/$CC"; fi
            if [ '${{ matrix.CONFIG.enableCcache }}' = "true" ]; then
              ARGS="$ARGS CC=\"ccache $CC\""
            else
              ARGS="$ARGS CC=$CC"
            fi
          fi
          echo "ARCH=$ARCH" >> $GITHUB_OUTPUT
          echo "ARGS=$ARGS" >> $GITHUB_OUTPUT
          echo "ü§î $ARGS"

      - name: üëç Build kernel
        working-directory: ${{ github.workspace }}/${{ matrix.CONFIG.kernelSource.name }}
        run: |
          export KBUILD_BUILD_HOST=dammer
          export KBUILD_BUILD_USER=dammer
          make ${{ steps.generate-args.outputs.ARGS }} ${{ matrix.CONFIG.kernelSource.defconfig }}
          make ${{ steps.generate-args.outputs.ARGS }}

      - name: üíõ Upload Images & dtb
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}-Image
          path: ${{ env.OUT_DIR }}/arch/${{ steps.generate-args.outputs.ARCH }}/boot/
          retention-days: 7

      - name: ‚è∞ Pack AnyKernel3
        if: ${{ matrix.CONFIG.AnyKernel3.use == 'true' }}
        run: |
          git clone --recursive --depth=1 -j $(nproc) https://github.com/osm0sis/AnyKernel3 AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          cp -f ${{ env.OUT_DIR }}/arch/${{ steps.generate-args.outputs.ARCH }}/boot/* AnyKernel3/
          cd AnyKernel3
          zip -q -r "${{ github.workspace }}/AnyKernel3-${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}.zip" *

      - name: üíæ Upload AnyKernel3
        if: ${{ matrix.CONFIG.AnyKernel3.use == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}
          path: ${{ github.workspace }}/AnyKernel3-${{ matrix.CONFIG.kernelSource.name }}-${{ env.BUILD_DATE }}.zip
