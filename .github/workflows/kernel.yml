name: Build Nethunter Kernel YAAP16

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_kernel:
    name: Build Kernel
    runs-on: ubuntu-24.04

    env:
      KERNEL_NAME: Op7Series_KSU_Nethunter
      KERNEL_REPO: https://github.com/yaap/kernel_oneplus_sm8150
      KERNEL_BRANCH: sixteen
      KERNEL_DEVICE: OnePlus7Series
      KERNEL_DEFCONFIG_PATH: gulch_defconfig
      OUT_DIR: ${{ github.workspace }}/out
      CCACHE_DIR: ${{ github.workspace }}/ccache
      ENABLE_KERNELSU: true
      ENABLE_LXC: true
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-android-
      CROSS_COMPILE_ARM32: arm-linux-androideabi-

    steps:
      # 1. 检出源码
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. 安装构建依赖（修正 Python 包）
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex \
            libncurses5-dev libncursesw5-dev \
            libssl-dev libelf-dev lzop \
            python3 python3-pip python3-setuptools python3-dev python3-venv python3-distutils \
            pkg-config unzip zip wget git rsync

      # 3. 安装 clang 工具链
      - name: Setup Clang
        run: |
          mkdir -p clang
          cd clang
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-16.0.7/clang+llvm-16.0.7-x86_64-linux-gnu-ubuntu-22.04.tar.xz
          tar -xf clang+llvm-16.0.7-x86_64-linux-gnu-ubuntu-22.04.tar.xz --strip-components=1
          cd ..
          echo "Clang path: $PWD/clang/bin"
          export PATH="$PWD/clang/bin:$PATH"

      # 4. 清理并生成配置
      - name: Setup Kernel Configuration
        run: |
          mkdir -p $OUT_DIR
          make -j$(nproc) O=$OUT_DIR ARCH=$ARCH $KERNEL_DEFCONFIG_PATH
          echo "✅ Kernel defconfig generated"

      # 5. 构建 Kernel (启用 KernelSU + LXC)
      - name: Build Kernel
        run: |
          make -j$(nproc) O=$OUT_DIR ARCH=$ARCH \
            CC="ccache clang" \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=$CROSS_COMPILE \
            CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32 \
            LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump READELF=llvm-readelf OBJSIZE=llvm-size \
            STRIP=llvm-strip LDGOLD=aarch64-linux-gnu-ld.gold \
            LLVM_AR=llvm-ar LLVM_DIS=llvm-dis \
            CONFIG_THINLTO=y \
            KERNELSU=$ENABLE_KERNELSU \
            LXC=$ENABLE_LXC

      # 6. 上传编译产物
      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nethunter-kernel-${{ github.run_number }}
          path: $OUT_DIR
